(()=>{"use strict";var e,o={727:(e,o,r)=>{const t=window.wp.blocks,n=window.wp.i18n,a=window.wp.blockEditor,l=window.wp.components,i=window.wp.element,s=window.wp.apiFetch;var c=r.n(s);const d=window.wp.data,m=window.ReactJSXRuntime,p="#2196f3",h={color:"#fff",borderRadius:"3px",padding:"8px 16px",display:"inline-flex",alignItems:"center",justifyContent:"center",textDecoration:"none",fontSize:"15px",fontWeight:"600",whiteSpace:"nowrap",minWidth:"85px",boxShadow:"0 1px 3px rgba(0, 0, 0, 0.1)"},u={padding:"32px",textAlign:"center",borderRadius:"4px"};function k({buttons:e,onChange:o,label:r}){return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)("p",{style:{fontSize:"13px",color:"#757575",marginTop:0},children:r}),e.map(((r,t)=>(0,m.jsxs)(l.Card,{style:{marginBottom:"16px",border:"1px solid #ddd"},children:[(0,m.jsx)(l.CardHeader,{children:(0,m.jsxs)(l.Flex,{justify:"space-between",align:"center",children:[(0,m.jsxs)("span",{style:{fontWeight:600},children:["ボタン ",t+1]}),(0,m.jsx)(l.Button,{isDestructive:!0,isSmall:!0,onClick:()=>{const r=[...e];r.splice(t,1),o(r)},icon:"trash"})]})}),(0,m.jsxs)(l.CardBody,{children:[(0,m.jsx)(l.TextControl,{label:"ボタンテキスト",value:r.text||"",onChange:r=>{const n=[...e];n[t]={...n[t],text:r},o(n)},placeholder:"例: 公式サイト"}),(0,m.jsx)(l.TextControl,{label:"リンクURL",value:r.url||"",onChange:r=>{const n=[...e];n[t]={...n[t],url:r},o(n)},placeholder:"https://example.com"}),(0,m.jsx)(l.ToggleControl,{label:"別タブで開く",checked:!1!==r.openInNewTab,onChange:r=>{const n=[...e];n[t]={...n[t],openInNewTab:r},o(n)}}),(0,m.jsxs)("div",{style:{marginTop:"12px"},children:[(0,m.jsxs)(l.Button,{variant:"secondary",onClick:()=>{const r=[...e];r[t]={...r[t],showColorPicker:!r[t].showColorPicker},o(r)},style:{width:"100%",marginBottom:"8px"},children:[r.showColorPicker?"色を選択中":"ボタンの色を選択",(0,m.jsx)("span",{style:{marginLeft:"8px",width:"20px",height:"20px",backgroundColor:r.color||p,display:"inline-block",borderRadius:"3px",border:"1px solid #ddd",verticalAlign:"middle"}})]}),r.showColorPicker&&(0,m.jsx)(l.ColorPicker,{color:r.color||p,onChange:r=>{const n=[...e];n[t]={...n[t],color:r},o(n)},enableAlpha:!0,defaultValue:p})]})]})]},t))),(0,m.jsx)(l.Button,{variant:"secondary",onClick:()=>{const r=[...e,{text:"",url:"",openInNewTab:!0,color:p}];o(r)},icon:"plus",style:{width:"100%",justifyContent:"center"},children:"ボタンを追加"})]})}const g={backgroundColor:"#ff9900",text:"Amazon"},x={backgroundColor:"#bf0000",text:"楽天市場"},f={backgroundColor:"#ff0033",text:"Yahoo!ショッピング"},w={backgroundColor:"#4dc9ff",text:"メルカリ"},_={backgroundColor:"#00bcd4",text:"DMM"};function j(e,o,r){return e.text&&e.url?(0,m.jsx)("div",{className:"plm-shop-custom",children:(0,m.jsx)("a",{rel:"nofollow noopener",href:e.url,target:!1!==e.openInNewTab?"_blank":"_self",style:{...h,backgroundColor:e.color||p},children:e.text})},`${o}-${r}`):null}function b(e,o,r){return(0,m.jsx)("div",{className:`plm-shop-${e}`,children:(0,m.jsx)("a",{rel:"nofollow noopener",href:o,target:"_blank",style:{...h,backgroundColor:r.backgroundColor},children:r.text})},e)}function C({type:e,message:o}){const r={loading:{...u,color:"#888",backgroundColor:"#f5f5f5",border:"1px dashed #ccc",display:"flex",alignItems:"center",gap:"8px"},error:{...u,color:"#d63638",backgroundColor:"#fff0f0",border:"1px solid #d63638"},empty:{...u,color:"#666",backgroundColor:"#f5f5f5",border:"1px dashed #ccc"}};return(0,m.jsxs)("div",{style:r[e],children:["loading"===e&&(0,m.jsx)(l.Spinner,{}),o]})}function y(e,o={}){const r=e.kw.split(",").map((e=>e.trim())).filter(Boolean).join(" "),t=window.ProductLinkMakerSettings||{},n=[];if((e.customButtonsBefore||[]).forEach(((e,o)=>{const r=j(e,"custom-before",o);r&&n.push(r)})),t.amazon&&!1!==e.showAmazon&&o.amazon_tracking_id){const e=`https://www.amazon.co.jp/gp/search?keywords=${encodeURIComponent(r)}&tag=${o.amazon_tracking_id}`;n.push(b("amazon",e,g))}if(t.rakuten&&!1!==e.showRakuten&&o.rakuten_affiliate_id){const e=`https://search.rakuten.co.jp/search/mall/${encodeURIComponent(r)}/`,t=`https://hb.afl.rakuten.co.jp/hgc/${o.rakuten_affiliate_id}/?pc=${encodeURIComponent(e)}&m=${encodeURIComponent(e)}`;n.push(b("rakuten",t,x))}if(t.yahoo&&!1!==e.showYahoo&&o.yahoo_sid&&o.yahoo_pid){const e=`https://search.shopping.yahoo.co.jp/search?p=${encodeURIComponent(r)}`,t=`https://ck.jp.ap.valuecommerce.com/servlet/referral?sid=${o.yahoo_sid}&pid=${o.yahoo_pid}&vc_url=${encodeURIComponent(e)}`;n.push(b("yahoo",t,f))}if(t.mercari&&!1!==e.showMercari&&o.mercari_id){const e=`https://jp.mercari.com/search?afid=${o.mercari_id}&keyword=${encodeURIComponent(r)}`;n.push(b("mercari",e,w))}if(t.dmm&&!1!==e.showDmm&&o.dmm_id){const e=`https://al.dmm.com/?lurl=https%3A%2F%2Fwww.dmm.com%2Fsearch%2F%3D%2Fsearchstr%3D${encodeURIComponent(r)}%2Fanalyze%3DV1ECCVYAUQQ_%2Flimit%3D30%2Fsort%3Drankprofile%2F&af_id=${o.dmm_id}&ch=link_tool&ch_id=link`;n.push(b("dmm",e,_))}return(e.customButtonsAfter||[]).forEach(((e,o)=>{const r=j(e,"custom-after",o);r&&n.push(r)})),n}function v({attributes:e,item:o,imageUrl:r,imageKey:t,itemTitle:n,itemLink:a,affiliateIds:l}){return(0,m.jsxs)("div",{className:"plm-product-box",children:[(0,m.jsx)("figure",{className:"plm-product-thumb",children:(0,m.jsx)("a",{rel:"nofollow noopener",href:a,className:"plm-product-thumb-link",target:"_blank",title:n,children:r&&(0,m.jsx)("img",{decoding:"async",src:r,alt:n||"商品画像",width:"128",height:"128",className:"plm-product-thumb-image"},t)})}),(0,m.jsxs)("div",{className:"plm-product-content",children:[(0,m.jsx)("div",{className:"plm-product-title",children:(0,m.jsx)("a",{rel:"nofollow noopener",href:a,className:"plm-product-title-link",target:"_blank",title:n,children:n||""})}),(0,m.jsxs)("div",{className:"plm-product-snippet",children:[!1!==e.showShop&&(o?.shopName||e.shop)&&(0,m.jsx)("div",{className:"plm-product-maker",children:o?.shopName||e.shop}),e.price&&(0,m.jsxs)("div",{className:"plm-product-price",children:[(0,m.jsx)("span",{className:"plm-price-value",children:o?.itemPrice?`￥ ${Number(o.itemPrice).toLocaleString("ja-JP")}`:"価格情報なし"}),(0,m.jsx)("span",{className:"acquired-date",children:o?.itemPrice?`（${(new Date).toLocaleDateString()} 時点）`:""})]}),e.desc&&(0,m.jsx)("div",{className:"plm-product-description",children:e.desc})]}),(0,m.jsx)("div",{className:"plm-product-buttons",children:e.kw&&e.kw.split(",").filter(Boolean).length>0&&y(e,l)})]})]})}const U=JSON.parse('{"UU":"product-link-maker/rakuten"}');(0,t.registerBlockType)(U.UU,{edit:function({attributes:e,setAttributes:o}){const[r,t]=(0,i.useState)(null),[s,p]=(0,i.useState)({}),[h,u]=(0,i.useState)(!0),[g,x]=(0,i.useState)(null),[f,w]=(0,i.useState)(!1),[_,j]=(0,i.useState)(!1),b=(0,i.useRef)(null),y=(0,i.useRef)(!0),U=(0,d.useSelect)((e=>{const o=e("core/editor");return o?o.getCurrentPostId():null}),[]),I=(0,i.useCallback)((async()=>{if(!e.id&&!e.no&&!e.kw)return t(null),o((e=>({...e,imageUrl:""}))),u(!1),void j(!0);u(!0),x(null);try{const r=new URLSearchParams({id:e.id||"",kw:e.kw||"",no:e.no||"",post_id:U||""}),n=await c()({path:`/product-link-maker/v1/rakuten/?${r.toString()}`});if(n&&n.Items&&n.Items.length>0&&n.Items[0]?.Item)t(n.Items[0].Item),p(n.affiliate_ids||{}),o((e=>({...e,imageUrl:n.Items[0].Item?.mediumImageUrls?.[0]?.imageUrl||""})));else if(n?.error){if(t(null),o((e=>({...e,imageUrl:""}))),x("APIエラー: "+(n.error_description||"リクエスト制限に達しました。しばらく待ってから再度お試しください。")),"rate_limit"!==n.error&&(e.id||e.kw||e.no))try{await c()({path:"/product-link-maker/v1/log-client-error/",method:"POST",data:{error_type:n.error,error_message:n.error_description||n.error,post_id:U,item_id:e.id||"",keyword:e.kw||e.no||""}})}catch(e){}}else if(t(null),o((e=>({...e,imageUrl:""}))),x("データが取得できませんでした"),e.id||e.kw||e.no)try{await c()({path:"/product-link-maker/v1/log-client-error/",method:"POST",data:{error_type:"no_data",error_message:"データが取得できませんでした。商品IDまたはキーワードが正しいか確認してください。",post_id:U,item_id:e.id||"",keyword:e.kw||e.no||""}})}catch(e){}}catch(r){if(t(null),o((e=>({...e,imageUrl:""}))),x("APIエラーが発生しました。しばらく待ってから再度お試しください。"),e.id||e.kw||e.no)try{await c()({path:"/product-link-maker/v1/log-client-error/",method:"POST",data:{error_type:"fetch_exception",error_message:"API取得中に例外が発生: "+(r.message||r.toString()),post_id:U,item_id:e.id||"",keyword:e.kw||e.no||""}})}catch(e){}}finally{u(!1),j(!0),y.current&&(y.current=!1)}}),[e.id,e.no,e.kw,U,o]),T=(0,i.useCallback)((async()=>{if(window.confirm("キャッシュを削除して最新データを取得しますか？")){w(!0);try{await c()({path:"/product-link-maker/v1/rakuten-cache/",method:"POST",data:{id:e.id,kw:e.kw,no:e.no}}),await I()}catch(e){console.error("Cache clear error:",e),alert("キャッシュ削除中にエラーが発生しました。")}finally{w(!1)}}}),[e.id,e.kw,e.no,I]);(0,i.useEffect)((()=>(b.current&&clearTimeout(b.current),e.id||e.no||e.kw?b.current=setTimeout((()=>{I()}),1e3):(t(null),u(!1),j(!0)),()=>{b.current&&clearTimeout(b.current)})),[e.id,e.no,e.kw]);const[B,S]=(0,i.useState)(0),N=e.imageUrl||(r&&r.mediumImageUrls&&r.mediumImageUrls[0]?r.mediumImageUrls[0].imageUrl:"");(0,i.useEffect)((()=>{S((e=>e+1))}),[N]);const P=e.title||(r?r.itemName:""),R=r&&(r.affiliateUrl||r.itemUrl)||"#";return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)(a.InspectorControls,{children:[(0,m.jsxs)(l.PanelBody,{title:(0,n.__)("商品情報設定","product-link-maker"),initialOpen:!0,children:[(0,m.jsx)(l.TextControl,{label:(0,n.__)("アイテムコード（ID）","product-link-maker"),help:e.no?(0,n.__)("商品番号が入力されている場合は入力できません","product-link-maker"):"",value:e.id,disabled:!!e.no,onChange:e=>{o({id:e,no:""})},placeholder:"book:11830886",style:e.no?{backgroundColor:"#f5f5f5",color:"#aaa"}:{}}),(0,m.jsx)(l.TextControl,{label:(0,n.__)("商品番号","product-link-maker"),help:e.id?(0,n.__)("アイテムコード（ID）が入力されている場合は入力できません","product-link-maker"):"",value:e.no,disabled:!!e.id,onChange:e=>{o({no:e,id:""})},placeholder:"4902102072625",style:e.id?{backgroundColor:"#f5f5f5",color:"#aaa"}:{}}),(0,m.jsx)(l.FormTokenField,{label:(0,n.__)("キーワード指定","product-link-maker"),value:e.kw?e.kw.split(",").filter(Boolean):[],onChange:e=>o({kw:e.join(",")}),placeholder:(0,n.__)("キーワードを入力してEnter","product-link-maker")}),(0,m.jsx)(l.TextControl,{label:(0,n.__)("ショップコード","product-link-maker"),value:e.shop,onChange:e=>o({shop:e})}),(0,m.jsx)(l.FormTokenField,{label:(0,n.__)("サーチ","product-link-maker"),value:e.search?e.search.split(",").filter(Boolean):[],onChange:e=>o({search:e.join(",")}),placeholder:(0,n.__)("サーチを入力してEnter","product-link-maker")}),(0,m.jsx)(l.TextareaControl,{label:(0,n.__)("タイトル","product-link-maker"),value:e.title,onChange:e=>o({title:e})}),(0,m.jsx)(l.ToggleControl,{label:(0,n.__)("店名表示","product-link-maker"),checked:!1!==e.showShop,onChange:e=>o({showShop:e})}),(0,m.jsx)(l.ToggleControl,{label:(0,n.__)("価格表示","product-link-maker"),checked:e.price,onChange:e=>o({price:e})}),(0,m.jsx)(l.TextareaControl,{label:(0,n.__)("説明文","product-link-maker"),value:e.desc,onChange:e=>o({desc:e})}),(0,m.jsx)(l.__experimentalHeading,{children:"画像アップロード"}),(0,m.jsx)(a.MediaUploadCheck,{children:(0,m.jsxs)("div",{style:{marginBottom:"0"},children:[(""!==e.imageUrl?e.imageUrl:r?.mediumImageUrls?.[0]?.imageUrl)&&(0,m.jsx)("div",{style:{marginBottom:"10px",display:"flex",justifyContent:"center",backgroundColor:"#eee"},children:(0,m.jsx)("img",{src:""!==e.imageUrl?e.imageUrl:r?.mediumImageUrls?.[0]?.imageUrl,alt:"",style:{display:"block"}})}),(0,m.jsx)(a.MediaUpload,{onSelect:e=>o({imageUrl:e.url||""}),allowedTypes:["image"],render:({open:r})=>(0,m.jsxs)(l.Flex,{children:[(0,m.jsx)(l.Button,{onClick:r,variant:"secondary",children:"画像を選択"}),e.imageUrl&&(0,m.jsx)(l.Button,{style:{marginTop:4},onClick:()=>o({imageUrl:""}),isDestructive:!0,children:(0,n.__)("画像をリセット","product-link-maker")})]})})]})}),(0,m.jsx)("div",{style:{margin:"24px 0 0 0"}}),(0,m.jsx)(l.__experimentalHeading,{children:"ボタン表示設定"}),(0,m.jsx)(l.ToggleControl,{label:(0,n.__)("Amazonボタンを表示","product-link-maker"),checked:!1!==e.showAmazon,onChange:e=>o({showAmazon:e})}),(0,m.jsx)(l.ToggleControl,{label:(0,n.__)("楽天ボタンを表示","product-link-maker"),checked:!1!==e.showRakuten,onChange:e=>o({showRakuten:e})}),(0,m.jsx)(l.ToggleControl,{label:(0,n.__)("Yahoo!ボタンを表示","product-link-maker"),checked:!1!==e.showYahoo,onChange:e=>o({showYahoo:e})}),(0,m.jsx)(l.ToggleControl,{label:(0,n.__)("メルカリボタンを表示","product-link-maker"),checked:!1!==e.showMercari,onChange:e=>o({showMercari:e})}),(0,m.jsx)(l.ToggleControl,{label:(0,n.__)("DMMボタンを表示","product-link-maker"),checked:!1!==e.showDmm,onChange:e=>o({showDmm:e})})]}),(0,m.jsx)(l.PanelBody,{title:(0,n.__)("カスタムボタン（前）","product-link-maker"),initialOpen:!0,children:(0,m.jsx)(k,{buttons:e.customButtonsBefore||[],onChange:e=>o({customButtonsBefore:e}),label:"既存のボタンの前に表示されるカスタムボタンを追加できます"})}),(0,m.jsx)(l.PanelBody,{title:(0,n.__)("カスタムボタン（後）","product-link-maker"),initialOpen:!0,children:(0,m.jsx)(k,{buttons:e.customButtonsAfter||[],onChange:e=>o({customButtonsAfter:e}),label:"既存のボタンの後に表示されるカスタムボタンを追加できます"})}),(0,m.jsx)(l.PanelBody,{title:(0,n.__)("アフィリエイト設定","product-link-maker"),initialOpen:!1,children:(0,m.jsx)(l.Button,{href:`${window.location.origin}/wp-admin/options-general.php?page=product-link-maker`,target:"_blank",className:"",variant:"primary",icon:"admin-generic",style:{marginTop:"5px",width:"100%",textAlign:"center"},children:(0,n.__)("アフィリエイト設定","product-link-maker")})})]}),(0,m.jsx)("div",{...(0,a.useBlockProps)(),children:h?(0,m.jsx)(C,{type:"loading",message:"Loading..."}):g?(0,m.jsx)(C,{type:"error",message:g}):e.id||e.no||e.kw?!_||!r&&(e.id||e.no)?(0,m.jsx)(C,{type:"loading",message:"Loading..."}):(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(v,{attributes:e,item:r,imageUrl:N,imageKey:B,itemTitle:P,itemLink:R,affiliateIds:s}),r&&(0,m.jsxs)("div",{className:"plm-admin-info",children:[(0,m.jsx)(l.Button,{variant:"secondary",onClick:T,disabled:f,isBusy:f,size:"small",children:f?"削除中...":"キャッシュ更新"}),r?.affiliateRate&&(0,m.jsxs)("span",{children:["料率: ",r.affiliateRate,"%"]})]})]}):(0,m.jsx)(C,{type:"empty",message:"商品情報を設定してください"})})]})}})}},r={};function t(e){var n=r[e];if(void 0!==n)return n.exports;var a=r[e]={exports:{}};return o[e](a,a.exports,t),a.exports}t.m=o,e=[],t.O=(o,r,n,a)=>{if(!r){var l=1/0;for(d=0;d<e.length;d++){for(var[r,n,a]=e[d],i=!0,s=0;s<r.length;s++)(!1&a||l>=a)&&Object.keys(t.O).every((e=>t.O[e](r[s])))?r.splice(s--,1):(i=!1,a<l&&(l=a));if(i){e.splice(d--,1);var c=n();void 0!==c&&(o=c)}}return o}a=a||0;for(var d=e.length;d>0&&e[d-1][2]>a;d--)e[d]=e[d-1];e[d]=[r,n,a]},t.n=e=>{var o=e&&e.__esModule?()=>e.default:()=>e;return t.d(o,{a:o}),o},t.d=(e,o)=>{for(var r in o)t.o(o,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:o[r]})},t.o=(e,o)=>Object.prototype.hasOwnProperty.call(e,o),(()=>{var e={68:0,708:0};t.O.j=o=>0===e[o];var o=(o,r)=>{var n,a,[l,i,s]=r,c=0;if(l.some((o=>0!==e[o]))){for(n in i)t.o(i,n)&&(t.m[n]=i[n]);if(s)var d=s(t)}for(o&&o(r);c<l.length;c++)a=l[c],t.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return t.O(d)},r=globalThis.webpackChunkproduct_link_maker=globalThis.webpackChunkproduct_link_maker||[];r.forEach(o.bind(null,0)),r.push=o.bind(null,r.push.bind(r))})();var n=t.O(void 0,[708],(()=>t(727)));n=t.O(n)})();